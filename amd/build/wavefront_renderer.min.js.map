{"version":3,"file":"wavefront_renderer.min.js","sources":["../src/wavefront_renderer.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Encapsules the behavior for creating a Wavefront 3D model in Moodle.\n *\n * Manages the UI while operations are occuring, including rendering and manipulating the model.\n *\n * @module     mod_wavefront/model_renderer\n * @class      model_renderer\n * @package    mod_wavefront\n * @copyright  2022 Ian Wild\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.9\n */\n\nimport WebGL from 'mod_wavefront/WebGL';\nimport * as THREE from 'mod_wavefront/three';\nimport { MTLLoader } from 'mod_wavefront/MTLLoader';\nimport { OBJLoader } from 'mod_wavefront/OBJLoader';\nimport { OrbitControls } from 'mod_wavefront/OrbitControls';\nimport jQuery from 'jquery';\n\nvar cameras = [], controls_array = [], scenes = [], renderers = [];\n\nvar containers = [];\nvar stage_widths = [], stage_heights = [], scene_backcolours = []; \nvar lightings = [], ambients = [], keyLights = [], fillLights = [], backLights = [];\n\nvar windowHalfX = window.innerWidth / 2;\nvar windowHalfY = window.innerHeight / 2;\n\nconst animate = () => {\n\t renderers.forEach( function(renderer, i) {\n\t    renderer.render(scenes[i], cameras[i]);\n\t \tcontrols_array[i].update();\n\t });\n\t \n\t requestAnimationFrame(animate);\n}\n\nexport const init = (stage) => {\n\n\tif (!WebGL.isWebGLAvailable() ) {\t\t\t\n\t    const warning = WebGL.getWebGLErrorMessage();\n\t\tdocument.getElementById( 'container' ).appendChild( warning );\n\t    return true;\n\t}\n\t\n\tconsole.log(stage);\n    \n\tvar container = document.getElementById(stage);\n\tconsole.log(container);\n\tcontainers.push(container);\n\t\n\t// Get stage attributes\n\tvar stage_width = jQuery(container).attr(\"data-stagewidth\");\n\tconsole.log(stage_width);\n\tstage_widths.push(stage_width);\n\tvar stage_height = jQuery(container).attr(\"data-stageheight\");\n\tconsole.log(stage_height);\n    stage_heights.push(stage_height);\n    var backcol = jQuery(container).attr(\"data-backcol\");\n\tconsole.log(backcol);\n    scene_backcolours.push(backcol);\n    \n\t// Get camera attributes\n\tvar cameraangle = jQuery(container).attr(\"data-cameraangle\");\n    console.log(cameraangle);\n\tvar camerafar = jQuery(container).attr(\"data-camerafar\");\n\tconsole.log(camerafar);\n\tvar camerax = jQuery(container).attr(\"data-camerax\");\n\tconsole.log(camerax);\n\tvar cameray = jQuery(container).attr(\"data-cameray\");\n\tconsole.log(cameray);\n\tvar cameraz = jQuery(container).attr(\"data-cameraz\");\n\tconsole.log(cameraz);\n\t\n\t// Get model files\n\tvar mtl = jQuery(container).attr(\"data-mtl\");\n\tconsole.log(mtl);\n\tvar mtl_file = decodeURIComponent(mtl);\n\tconsole.log(mtl_file);\n\tvar obj = jQuery(container).attr(\"data-obj\");\n\tconsole.log(obj);\n\tvar obj_file = decodeURIComponent(obj);\n\tconsole.log(obj_file);\n\t\n\t/* Load model */\n\tvar mtlLoader = new MTLLoader();\n    mtlLoader.load(mtl_file, (materials) => {\n\n        materials.preload();\n\n        var objLoader = new OBJLoader();\n        objLoader.setMaterials(materials);\n        objLoader.load(obj_file, function (object) {\n        \n        \t// Create scene\n\t\t\tvar scene = new THREE.Scene();\n\t\t\tscenes.push(scene);\n\t\t\t\n\t\t\t// Camera\n\t\t\tvar SCREEN_WIDTH = stage_width, SCREEN_HEIGHT = stage_height;\n\t\t\tvar VIEW_ANGLE = Number(cameraangle), ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.1, FAR = Number(camerafar);\n\t\t\tvar camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);\n\t\t\tcameras.push(camera);\n\t\t\tscene.add(camera);\n\t\t\tcamera.position.set(Number(camerax),Number(cameray),Number(cameraz));\t\n\t\t\n\t\t\tvar ambient = new THREE.AmbientLight(0xffffff, 1.0);\n\t\t\tambients.push(ambient);\t\n\t\t\tscene.add(ambient);\n\t\t\t// Lighting\n\t\t\tvar keyLight = new THREE.DirectionalLight(new THREE.Color('hsl(30, 100%, 75%)'), 1.0);\n\t\t\tkeyLights.push(keyLight);\n\t\t\tkeyLight.position.set(-100, 0, 100);\n\t\t\n\t\t\tvar fillLight = new THREE.DirectionalLight(new THREE.Color('hsl(240, 100%, 75%)'), 0.75);\n\t\t\tfillLights.push(fillLight);\n\t\t\tfillLight.position.set(100, 0, 100);\n\t\t\n\t\t\tvar backLight = new THREE.DirectionalLight(0xffffff, 1.0);\n\t\t\tbackLights.push(backLight);\n\t\t\tbackLight.position.set(100, 0, -100).normalize();\n\t\t\n\t\t\tscene.add(keyLight);\n\t\t\tscene.add(fillLight);\n\t\t\tscene.add(backLight);\n            scene.add(object);\n            var iCol = Number(\"0x\" + backcol); \n            scene.background = new THREE.Color(iCol);\n\n\t\t\t/* Renderer */\n    \n\t\t    var renderer = new THREE.WebGLRenderer();\n\t\t    renderer.setPixelRatio(window.devicePixelRatio);\n\t\t    renderer.setSize(stage_width, stage_height);\n\t\t    renderer.setClearColor(new THREE.Color(\"hsl(0, 0%, 10%)\"));\n\t\t    renderers.push(renderer);\n\t\t    container.appendChild(renderer.domElement);\n\t\t                \n            /* Controls */\n\n\t\t    var controls = new OrbitControls(camera, renderer.domElement);\n\t\t    controls.enableDamping = true;\n\t\t    controls.dampingFactor = 0.25;\n\t\t    controls_array.push(controls);\n\t\t     \n\t\t    /* Events */\n\t\t  \n\t\t    window.addEventListener('keydown', function (e) {\n\t\t    \te.stopPropagation();\n\t\t    \tif (e.code === 'KeyL') {\n\t\t            lighting = !lighting;\n\t\t            if (lighting) {\n\t\t                ambient.intensity = 0.25;\n\t\t                scene.add(keyLight);\n\t\t                scene.add(fillLight);\n\t\t                scene.add(backLight);\n\t\t            } else {\n\t\t                ambient.intensity = 1.0;\n\t\t                scene.remove(keyLight);\n\t\t                scene.remove(fillLight);\n\t\t                scene.remove(backLight);\n\t\t            }\n\t\t        }\t\n\t\t    }, false);\n\t\t    \n\t\t    /* Remove the loading spinner */\n\t\t    jQuery(container).next().remove();\n\t\t\n\t\t    /* Start animation */\n\t\t\tanimate();\n            \n        });\n    }); \n};"],"names":["cameras","controls_array","scenes","renderers","containers","stage_widths","stage_heights","scene_backcolours","ambients","keyLights","fillLights","backLights","window","innerWidth","innerHeight","animate","forEach","renderer","i","render","update","requestAnimationFrame","stage","WebGL","isWebGLAvailable","warning","getWebGLErrorMessage","document","getElementById","appendChild","console","log","container","push","stage_width","attr","stage_height","backcol","cameraangle","camerafar","camerax","cameray","cameraz","mtl","mtl_file","decodeURIComponent","obj","obj_file","MTLLoader","load","materials","preload","objLoader","OBJLoader","setMaterials","object","scene","THREE","Scene","SCREEN_WIDTH","SCREEN_HEIGHT","VIEW_ANGLE","Number","ASPECT","FAR","camera","PerspectiveCamera","add","position","set","ambient","AmbientLight","keyLight","DirectionalLight","Color","fillLight","backLight","normalize","iCol","background","WebGLRenderer","setPixelRatio","devicePixelRatio","setSize","setClearColor","domElement","controls","OrbitControls","enableDamping","dampingFactor","addEventListener","e","stopPropagation","code","lighting","intensity","remove","next"],"mappings":"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"}