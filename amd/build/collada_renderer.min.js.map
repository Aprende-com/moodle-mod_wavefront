{"version":3,"file":"collada_renderer.min.js","sources":["../src/collada_renderer.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Encapsules the behavior for creating a Collada 3D model in Moodle.\n *\n * Manages the UI while operations are occuring, including rendering and manipulating the model.\n *\n * @module     mod_wavefront/collada_renderer\n * @class      collada_renderer\n * @package    mod_wavefront\n * @copyright  2022 Ian Wild\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.9\n */\n\nimport WebGL from 'mod_wavefront/WebGL';\nimport * as THREE from 'mod_wavefront/three';\nimport { ColladaLoader } from 'mod_wavefront/ColladaLoader';\nimport { OrbitControls } from 'mod_wavefront/OrbitControls';\n\nimport jQuery from 'jquery';\n\nvar cameras = [], controls_array = [], scenes = [], renderers = [];\n\nvar containers = [];\n \nvar stage_widths = [], stage_heights = [], scene_backcolours = []; \nvar ambients = [], pointlights = [];\nvar clocks = [], mixers = [];\n\nconst animate = () => {\n\t\n\trenderers.forEach( function(renderer, i) {\n\t\tvar delta = clocks[i].getDelta();\n\n\t\tif ( mixers[i] !== undefined ) {\n\n\t\t\tmixers[i].update( delta );\n\n\t\t}\n\n\t    renderer.render(scenes[i], cameras[i]);\n\t \tcontrols_array[i].update();\n\t});\n\t\n\trequestAnimationFrame( animate );\n}\n\nexport const init = (stage) => {\n\n\tif (!WebGL.isWebGLAvailable() ) {\t\t\t\n\t    const warning = WebGL.getWebGLErrorMessage();\n\t\tdocument.getElementById( 'container' ).appendChild( warning );\n\t    return true;\n\t}\n\t\n\tconsole.log(stage);\n    \n\tvar container = document.getElementById(stage);\n\tconsole.log(container);\n\tcontainers.push(container);\n\t\n\t// Get stage attributes\n\tvar stage_width = jQuery(container).attr(\"data-stagewidth\");\n\tconsole.log(stage_width);\n\tstage_widths.push(stage_width);\n\tvar stage_height = jQuery(container).attr(\"data-stageheight\");\n\tconsole.log(stage_height);\n    stage_heights.push(stage_height);\n    var backcol = jQuery(container).attr(\"data-backcol\");\n\tconsole.log(backcol);\n    scene_backcolours.push(backcol);\n    \n\t// Get camera attributes\n\tvar cameraangle = jQuery(container).attr(\"data-cameraangle\");\n    console.log(cameraangle);\n    var cameranear = jQuery(container).attr(\"data-cameranear\");\n\tconsole.log(cameranear);\n\tvar camerafar = jQuery(container).attr(\"data-camerafar\");\n\tconsole.log(camerafar);\n\tvar camerax = jQuery(container).attr(\"data-camerax\");\n\tconsole.log(camerax);\n\tvar cameray = jQuery(container).attr(\"data-cameray\");\n\tconsole.log(cameray);\n\tvar cameraz = jQuery(container).attr(\"data-cameraz\");\n\tconsole.log(cameraz);\n\t\n\t// Get model files\n\tvar baseurl = jQuery(container).attr(\"data-baseurl\");\n\tvar base_url = decodeURIComponent(baseurl);\n\tconsole.log(base_url);\n\t\n\tvar dae = jQuery(container).attr(\"data-dae\");\n\tvar dae_file = decodeURIComponent(dae);\n\tconsole.log(dae_file);\n\t\n\t// Create scene\n\tvar scene = new THREE.Scene();\n\tscenes.push(scene);\n\t\n\t// Camera\n\tvar SCREEN_WIDTH = stage_width, SCREEN_HEIGHT = stage_height;\n\tvar VIEW_ANGLE = Number(cameraangle), ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = Number(cameranear), FAR = Number(camerafar);\n\tvar camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);\n\tcameras.push(camera);\n\tscene.add(camera);\n\tcamera.position.set(Number(camerax),Number(cameray),Number(cameraz));\t\n\n\tclock = new THREE.Clock();\n\tclocks.push(clock);\n\t\n\t/* Load model */\n\tvar daeLoader = new ColladaLoader();\n    daeLoader.load(dae_file, (collada) => {\n\n\t\tvar animations = collada.animations;\n\t\tvar avatar = collada.scene;\n\n\t\tavatar.traverse( function ( node ) {\n\n\t\t\tif ( node.isSkinnedMesh ) {\n\n\t\t\t\tnode.frustumCulled = false;\n\n\t\t\t}\n\n\t\t} );\n\n\t\tmixer = new THREE.AnimationMixer( avatar );\n\t\tmixers.push(mixer);\n\t\t\n\t\tvar action = mixer.clipAction( animations[ 0 ] ).play();\n\n\t\tscene.add( avatar );\n\t\tvar iCol = Number(\"0x\" + backcol); \n        scene.background = new THREE.Color(iCol);\n\t\t\n\t\tvar ambientLight = new THREE.AmbientLight( 0xffffff, 0.2 );\n\t\tambients.push[ambientLight];\n\t\tscene.add( ambientLight );\n\n\t\tvar pointLight = new THREE.PointLight( 0xffffff, 0.8 );\n\t\tpointlights.push[pointLight];\n\t\t\n\t\tscene.add( camera );\n\t\tcamera.add( pointLight );\n\n\t\t/* Renderer */\n\n\t\tvar renderer = new THREE.WebGLRenderer( { antialias: true } );\n\t\trenderer.setPixelRatio(window.devicePixelRatio);\n\t\trenderer.setSize(stage_width, stage_height);\n\t\trenderer.setClearColor(new THREE.Color(\"hsl(0, 0%, 10%)\"));\n\t\trenderers.push(renderer);\n\t\tcontainer.appendChild(renderer.domElement);\n\n\t\t/* Controls */\n\n\t\tvar controls = new OrbitControls( camera, renderer.domElement );\n\t\tcontrols.enableDamping = true;\n\t\tcontrols.dampingFactor = 0.25;\n\t\tcontrols_array.push(controls);\n\t\tcontrols.target.set(0, 2, 0);\n\t\t\n\t\t/* Remove the loading spinner */\n\t\tjQuery(container).next().remove();\n\t\t\t\n\t    /* Start animation */\n\t\tanimate();\n        \n    }); \n};"],"names":["cameras","controls_array","scenes","renderers","containers","stage_widths","stage_heights","scene_backcolours","ambients","pointlights","clocks","mixers","animate","forEach","renderer","i","delta","getDelta","undefined","update","render","requestAnimationFrame","stage","WebGL","isWebGLAvailable","warning","getWebGLErrorMessage","document","getElementById","appendChild","console","log","container","push","stage_width","attr","stage_height","backcol","cameraangle","cameranear","camerafar","camerax","cameray","cameraz","baseurl","base_url","decodeURIComponent","dae","dae_file","scene","THREE","Scene","SCREEN_WIDTH","SCREEN_HEIGHT","VIEW_ANGLE","Number","ASPECT","NEAR","FAR","camera","PerspectiveCamera","add","position","set","clock","Clock","ColladaLoader","load","collada","animations","avatar","traverse","node","isSkinnedMesh","frustumCulled","mixer","AnimationMixer","clipAction","play","iCol","background","Color","ambientLight","AmbientLight","pointLight","PointLight","WebGLRenderer","antialias","setPixelRatio","window","devicePixelRatio","setSize","setClearColor","domElement","controls","OrbitControls","enableDamping","dampingFactor","target","next","remove"],"mappings":"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"}