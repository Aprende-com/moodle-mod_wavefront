{"version":3,"file":"collada_ar.min.js","sources":["../src/collada_ar.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Encapsules the behavior for creating a Wavefront 3D model in Moodle.\n *\n * Manages the UI while operations are occuring, including rendering and manipulating the model.\n *\n * @module     mod_wavefront/collada_ar\n * @class      ar_renderer\n * @package    mod_wavefront\n * @copyright  2022 Ian Wild\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.9\n */\n\nimport * as THREE from 'mod_wavefront/three';\nimport { ColladaLoader } from 'mod_wavefront/ColladaLoader';\nimport { ARButton } from 'mod_wavefront/ARButton';\nimport jQuery from 'jquery';\n\nlet camera, scene, renderer, mixer = null, clock = null;\nlet controller;\n\nlet reticle;\nlet object;\nlet objectscale;\n\nlet hitTestSource = null;\nlet hitTestSourceRequested = false;\n\n\nexport const init = (stage, scale) => {\n\n\tvar container = document.getElementById(stage);\n    console.log(container);\n    \n    // Object vector scaling\n    objectscale = scale;\n    \n    // Get model files\n\tvar baseurl = jQuery(container).attr(\"data-baseurl\");\n\tvar base_url = decodeURIComponent(baseurl);\n\tconsole.log(base_url);\n\t\n\tvar dae = jQuery(container).attr(\"data-dae\");\n\tvar dae_file = decodeURIComponent(dae);\n\tconsole.log(dae_file);\n\t\n\t// Get camera attributes\n\tvar cameraangle = jQuery(container).attr(\"data-cameraangle\");\n    console.log(cameraangle);\n    var cameranear = jQuery(container).attr(\"data-cameranear\");\n\tconsole.log(cameranear);\n\tvar camerafar = jQuery(container).attr(\"data-camerafar\");\n\tconsole.log(camerafar);\n\tvar camerax = jQuery(container).attr(\"data-camerax\");\n\tconsole.log(camerax);\n\tvar cameray = jQuery(container).attr(\"data-cameray\");\n\tconsole.log(cameray);\n\tvar cameraz = jQuery(container).attr(\"data-cameraz\");\n\tconsole.log(cameraz);\n\t\n\tclock = new THREE.Clock();\n\n\tscene = new THREE.Scene();\n\n\tvar VIEW_ANGLE = Number(cameraangle), ASPECT = window.innerWidth / window.innerHeight, NEAR = Number(cameranear), FAR = Number(camerafar);\n\tcamera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);\n\tcamera.position.set(Number(camerax),Number(cameray),Number(cameraz));\t\n\n\t// Lighting\n\tvar keyLight = new THREE.DirectionalLight(new THREE.Color('hsl(30, 100%, 75%)'), 1.0);\n\tkeyLight.position.set(-100, 0, 100);\n\t\t\t\n\tvar fillLight = new THREE.DirectionalLight(new THREE.Color('hsl(240, 100%, 75%)'), 0.75);\n\tfillLight.position.set(100, 0, 100);\n\t\t\t\n\tvar backLight = new THREE.DirectionalLight(0xffffff, 1.0);\n\tbackLight.position.set(100, 0, -100).normalize();\n\n\tscene.add(keyLight);\n\tscene.add(fillLight);\n\tscene.add(backLight);\n\t\n\t//\n\n\trenderer = new THREE.WebGLRenderer( { antialias: true, alpha: true } );\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\trenderer.xr.enabled = true;\n\trenderer.xr.setReferenceSpaceType( 'local' );\n\tcontainer.appendChild( renderer.domElement );\n\n    //\n    \n    renderer.xr.addEventListener('sessionend', function ( event ) {\n    \tscene.remove( object );\n\t\tscene.add( reticle );\n\t\treticle.visible = false;\n\t\tcontroller.addEventListener( 'select', onSelect );\n\t});\n    \n\t//\n\n\tdocument.body.appendChild( ARButton.createButton( renderer, { requiredFeatures: [ 'hit-test' ] } ) );\n\n\t//\n\n\tfunction onSelect() {\n\n\t\tif ( reticle.visible ) {\n\n\t\t\t/* Load model */\n\t\t\tvar daeLoader = new ColladaLoader();\n    \t\tdaeLoader.load(dae_file, (collada) => {\n\n\t\t\t\tvar animations = collada.animations;\n\t\t\t\tvar avatar = collada.scene;\n\n\t\t\t\tavatar.traverse( function ( node ) {\n\t\t\n\t\t\t\t\tif ( node.isSkinnedMesh ) {\n\t\t\n\t\t\t\t\t\tnode.frustumCulled = false;\n\t\t\n\t\t\t\t\t}\n\t\t\n\t\t\t\t} );\n\n\t\t\t\tmixer = new THREE.AnimationMixer( avatar );\n\t\t\t\t\n\t\t\t\t// TODO play all animations\n\t\t\t\tmixer.clipAction( animations[ 0 ] ).play();\n\t\t\t\tvar translation = new THREE.Vector3();\n  \t\t\t\tvar rotation = new THREE.Quaternion();\n  \t\t\t\tvar scale = new THREE.Vector3();\n\n\t\t\t\treticle.matrix.decompose( avatar.position, rotation, scale);\n\t\t        avatar.scale.set(objectscale,objectscale,objectscale);\n\t\t\t\tscene.add( avatar );\n\t\t\t\t\n\t\t\t\tcontroller.removeEventListener( 'select', onSelect );\n\t\t\t\tscene.remove(reticle);\n\t\t\t});\n\t\t}\n\t}\n\n\tcontroller = renderer.xr.getController( 0 );\n\tcontroller.addEventListener( 'select', onSelect );\n\tscene.add( controller );\n\n\treticle = new THREE.Mesh(\n\t\tnew THREE.RingGeometry( 0.15, 0.2, 32 ).rotateX( - Math.PI / 2 ),\n\t\tnew THREE.MeshBasicMaterial()\n\t);\n\treticle.matrixAutoUpdate = false;\n\treticle.visible = false;\n\tscene.add( reticle );\n\n\t//\n\n\twindow.addEventListener( 'resize', onWindowResize );\n\n    animate();\n}\n\nfunction onWindowResize() {\n\n\tcamera.aspect = window.innerWidth / window.innerHeight;\n\tcamera.updateProjectionMatrix();\n\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\n}\n\n//\n\nfunction render( timestamp, frame ) {\n\tif ( frame ) {\n\n\t\tconst referenceSpace = renderer.xr.getReferenceSpace();\n\t\tconst session = renderer.xr.getSession();\n\n\t\tif ( hitTestSourceRequested === false ) {\n\n\t\t\tsession.requestReferenceSpace( 'viewer' ).then( function ( referenceSpace ) {\n\n\t\t\t\tsession.requestHitTestSource( { space: referenceSpace } ).then( function ( source ) {\n\n\t\t\t\t\thitTestSource = source;\n\n\t\t\t\t} );\n\n\t\t\t} );\n\n\t\t\tsession.addEventListener( 'end', function () {\n\n\t\t\t\thitTestSourceRequested = false;\n\t\t\t\thitTestSource = null;\n\n\t\t\t} );\n\n\t\t\thitTestSourceRequested = true;\n\n\t\t}\n\n\t\tif ( hitTestSource ) {\n\n\t\t\tconst hitTestResults = frame.getHitTestResults( hitTestSource );\n\n\t\t\tif ( hitTestResults.length ) {\n\n\t\t\t\tconst hit = hitTestResults[ 0 ];\n\n\t\t\t\treticle.visible = true;\n\t\t\t\treticle.matrix.fromArray( hit.getPose( referenceSpace ).transform.matrix );\n\n\t\t\t} else {\n\n\t\t\t\treticle.visible = false;\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\t\n\tif(mixer !== null) {\n\t\tvar delta = clock.getDelta();\n\n\t\tmixer.update( delta );\t\n\t}\n\n    renderer.render(scene, camera);\n}\n\nfunction animate() {\n\n\trenderer.setAnimationLoop( render );\n\n}\n"],"names":["camera","scene","renderer","controller","reticle","objectscale","mixer","clock","hitTestSource","hitTestSourceRequested","onWindowResize","aspect","window","innerWidth","innerHeight","updateProjectionMatrix","setSize","render","timestamp","frame","referenceSpace","xr","getReferenceSpace","session","getSession","requestReferenceSpace","then","requestHitTestSource","space","source","addEventListener","hitTestResults","getHitTestResults","length","hit","visible","matrix","fromArray","getPose","transform","delta","getDelta","update","stage","scale","container","document","getElementById","console","log","baseurl","attr","base_url","decodeURIComponent","dae","dae_file","cameraangle","cameranear","camerafar","camerax","cameray","cameraz","THREE","Clock","Scene","VIEW_ANGLE","Number","ASPECT","NEAR","FAR","PerspectiveCamera","position","set","keyLight","DirectionalLight","Color","fillLight","backLight","onSelect","ColladaLoader","load","collada","animations","avatar","traverse","node","isSkinnedMesh","frustumCulled","AnimationMixer","clipAction","play","Vector3","rotation","Quaternion","decompose","add","removeEventListener","remove","normalize","WebGLRenderer","antialias","alpha","setPixelRatio","devicePixelRatio","enabled","setReferenceSpaceType","appendChild","domElement","event","object","body","ARButton","createButton","requiredFeatures","getController","Mesh","RingGeometry","rotateX","Math","PI","MeshBasicMaterial","matrixAutoUpdate","setAnimationLoop"],"mappings":"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"}