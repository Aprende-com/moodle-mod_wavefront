{"version":3,"sources":["../src/ar_renderer.js"],"names":["camera","scene","renderer","controller","reticle","object","objectscale","hitTestSource","hitTestSourceRequested","init","stage","scale","container","document","getElementById","console","log","mtl","attr","mtl_file","decodeURIComponent","obj","obj_file","cameraangle","camerafar","camerax","cameray","cameraz","THREE","Scene","ASPECT","window","innerWidth","innerHeight","PerspectiveCamera","position","set","keyLight","DirectionalLight","Color","fillLight","backLight","normalize","add","WebGLRenderer","antialias","alpha","setPixelRatio","devicePixelRatio","setSize","xr","enabled","appendChild","domElement","addEventListener","remove","visible","onSelect","body","ARButton","createButton","requiredFeatures","mtlLoader","MTLLoader","load","materials","preload","objLoader","OBJLoader","setMaterials","matrix","decompose","quaternion","removeEventListener","getController","Mesh","RingGeometry","rotateX","Math","PI","MeshBasicMaterial","matrixAutoUpdate","onWindowResize","animate","aspect","updateProjectionMatrix","setAnimationLoop","render","timestamp","frame","referenceSpace","getReferenceSpace","session","getSession","requestReferenceSpace","then","requestHitTestSource","space","source","hitTestResults","getHitTestResults","length","hit","fromArray","getPose","transform"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Encapsules the behavior for creating a Wavefront 3D model in Moodle.\n *\n * Manages the UI while operations are occuring, including rendering and manipulating the model.\n *\n * @module     mod_wavefront/ar_renderer\n * @class      ar_renderer\n * @package    mod_wavefront\n * @copyright  2022 Ian Wild\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.9\n */\n\nimport WebGL from 'mod_wavefront/WebGL';\nimport * as THREE from 'mod_wavefront/three';\nimport { MTLLoader } from 'mod_wavefront/MTLLoader';\nimport { OBJLoader } from 'mod_wavefront/OBJLoader';\nimport { OrbitControls } from 'mod_wavefront/OrbitControls';\nimport { ARButton } from 'mod_wavefront/ARButton';\nimport jQuery from 'jquery';\n\nlet container;\nlet camera, scene, renderer;\nlet controller;\n\nlet reticle;\nlet object;\nlet objectscale;\n\nlet hitTestSource = null;\nlet hitTestSourceRequested = false;\n\n\nexport const init = (stage, scale) => {\n\n\tvar container = document.getElementById(stage);\n    console.log(container);\n    \n    // Object vector scaling\n    objectscale = scale;\n    \n    // Get model files\n\tvar mtl = jQuery(container).attr(\"data-mtl\");\n\tconsole.log(mtl);\n\tvar mtl_file = decodeURIComponent(mtl);\n\tconsole.log(mtl_file);\n\tvar obj = jQuery(container).attr(\"data-obj\");\n\tconsole.log(obj);\n\tvar obj_file = decodeURIComponent(obj);\n\tconsole.log(obj_file);\n\t\n\t// Get camera attributes\n\tvar cameraangle = jQuery(container).attr(\"data-cameraangle\");\n    console.log(cameraangle);\n\tvar camerafar = jQuery(container).attr(\"data-camerafar\");\n\tconsole.log(camerafar);\n\tvar camerax = jQuery(container).attr(\"data-camerax\");\n\tconsole.log(camerax);\n\tvar cameray = jQuery(container).attr(\"data-cameray\");\n\tconsole.log(cameray);\n\tvar cameraz = jQuery(container).attr(\"data-cameraz\");\n\tconsole.log(cameraz);\n\n\tscene = new THREE.Scene();\n\n\tvar VIEW_ANGLE = Number(cameraangle), ASPECT = window.innerWidth / window.innerHeight, NEAR = 0.1, FAR = Number(camerafar);\n\tcamera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);\n\tcamera.position.set(Number(camerax),Number(cameray),Number(cameraz));\t\n\n\t// Lighting\n\tvar keyLight = new THREE.DirectionalLight(new THREE.Color('hsl(30, 100%, 75%)'), 1.0);\n\tkeyLight.position.set(-100, 0, 100);\n\t\t\t\n\tvar fillLight = new THREE.DirectionalLight(new THREE.Color('hsl(240, 100%, 75%)'), 0.75);\n\tfillLight.position.set(100, 0, 100);\n\t\t\t\n\tvar backLight = new THREE.DirectionalLight(0xffffff, 1.0);\n\tbackLight.position.set(100, 0, -100).normalize();\n\n\tscene.add(keyLight);\n\tscene.add(fillLight);\n\tscene.add(backLight);\n\t\n\t//\n\n\trenderer = new THREE.WebGLRenderer( { antialias: true, alpha: true } );\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\trenderer.xr.enabled = true;\n\tcontainer.appendChild( renderer.domElement );\n\n    //\n    \n    renderer.xr.addEventListener('sessionend', function ( event ) {\n    \tscene.remove( object );\n\t\tscene.add( reticle );\n\t\treticle.visible = false;\n\t\tcontroller.addEventListener( 'select', onSelect );\n\t});\n    \n\t//\n\n\tdocument.body.appendChild( ARButton.createButton( renderer, { requiredFeatures: [ 'hit-test' ] } ) );\n\n\t//\n\n\tfunction onSelect() {\n\n\t\tif ( reticle.visible ) {\n\n\t\t\t/* Load model */\n\t\t\tvar mtlLoader = new MTLLoader();\n\t\t    mtlLoader.load(mtl_file, (materials) => {\n\t\t\n\t\t        materials.preload();\n\t\t\n\t\t        var objLoader = new OBJLoader();\n\t\t        objLoader.setMaterials(materials);\n\t\t        objLoader.load(obj_file, function (obj) {\n\t\t            object = obj;\n\t\t        \treticle.matrix.decompose( object.position, object.quaternion, object.scale );\n\t\t        \tobject.scale.set(objectscale,objectscale,objectscale);\n\t\t\t\t\tscene.add( object );\n\t\t\t\t\tcontroller.removeEventListener( 'select', onSelect );\n\t\t\t\t\tscene.remove(reticle);\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\tcontroller = renderer.xr.getController( 0 );\n\tcontroller.addEventListener( 'select', onSelect );\n\tscene.add( controller );\n\n\treticle = new THREE.Mesh(\n\t\tnew THREE.RingGeometry( 0.15, 0.2, 32 ).rotateX( - Math.PI / 2 ),\n\t\tnew THREE.MeshBasicMaterial()\n\t);\n\treticle.matrixAutoUpdate = false;\n\treticle.visible = false;\n\tscene.add( reticle );\n\n\t//\n\n\twindow.addEventListener( 'resize', onWindowResize );\n\n    animate();\n}\n\nfunction onWindowResize() {\n\n\tcamera.aspect = window.innerWidth / window.innerHeight;\n\tcamera.updateProjectionMatrix();\n\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\n}\n\n//\n\nfunction animate() {\n\n\trenderer.setAnimationLoop( render );\n\n}\n\nfunction render( timestamp, frame ) {\n\n\tif ( frame ) {\n\n\t\tconst referenceSpace = renderer.xr.getReferenceSpace();\n\t\tconst session = renderer.xr.getSession();\n\n\t\tif ( hitTestSourceRequested === false ) {\n\n\t\t\tsession.requestReferenceSpace( 'viewer' ).then( function ( referenceSpace ) {\n\n\t\t\t\tsession.requestHitTestSource( { space: referenceSpace } ).then( function ( source ) {\n\n\t\t\t\t\thitTestSource = source;\n\n\t\t\t\t} );\n\n\t\t\t} );\n\n\t\t\tsession.addEventListener( 'end', function () {\n\n\t\t\t\thitTestSourceRequested = false;\n\t\t\t\thitTestSource = null;\n\n\t\t\t} );\n\n\t\t\thitTestSourceRequested = true;\n\n\t\t}\n\n\t\tif ( hitTestSource ) {\n\n\t\t\tconst hitTestResults = frame.getHitTestResults( hitTestSource );\n\n\t\t\tif ( hitTestResults.length ) {\n\n\t\t\t\tconst hit = hitTestResults[ 0 ];\n\n\t\t\t\treticle.visible = true;\n\t\t\t\treticle.matrix.fromArray( hit.getPose( referenceSpace ).transform.matrix );\n\n\t\t\t} else {\n\n\t\t\t\treticle.visible = false;\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\trenderer.render( scene, camera );\n\n}"],"file":"ar_renderer.min.js"}