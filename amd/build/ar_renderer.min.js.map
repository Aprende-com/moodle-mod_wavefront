{"version":3,"sources":["../src/ar_renderer.js"],"names":["camera","scene","renderer","controller","reticle","hitTestSource","hitTestSourceRequested","mtlLoader","monkeymesh","init","stage","container","document","getElementById","createElement","body","appendChild","THREE","Scene","PerspectiveCamera","window","innerWidth","innerHeight","position","z","light","HemisphereLight","set","add","WebGLRenderer","antialias","alpha","setPixelRatio","devicePixelRatio","setSize","xr","enabled","domElement","MTLLoader","setPath","load","materials","preload","objLoader","OBJLoader","setMaterials","object","boxgeometry","BoxBufferGeometry","translate","onSelect","visible","material","MeshPhongMaterial","color","Math","random","mesh","Mesh","setFromMatrixPosition","matrix","scale","getController","addEventListener","RingBufferGeometry","rotateX","PI","MeshBasicMaterial","matrixAutoUpdate","onWindowResize","animate","aspect","updateProjectionMatrix","setAnimationLoop","render","timestamp","frame","referenceSpace","getReferenceSpace","session","getSession","requestReferenceSpace","then","requestHitTestSource","space","source","hitTestResults","getHitTestResults","length","hit","fromArray","getPose","transform"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Encapsules the behavior for creating a Wavefront 3D model in Moodle.\n *\n * Manages the UI while operations are occuring, including rendering and manipulating the model.\n *\n * @module     mod_wavefront/ar_renderer\n * @class      ar_renderer\n * @package    mod_wavefront\n * @copyright  2022 Ian Wild\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.9\n */\n\nimport WebGL from 'mod_wavefront/WebGL';\nimport * as THREE from 'mod_wavefront/three';\nimport { MTLLoader } from 'mod_wavefront/MTLLoader';\nimport { OBJLoader } from 'mod_wavefront/OBJLoader';\nimport { OrbitControls } from 'mod_wavefront/OrbitControls';\nimport { ARButton } from 'mod_wavefront/ARButton';\nimport jQuery from 'jquery';\n\nvar container;\nvar camera, scene, renderer;\nvar controller;\n\nvar reticle;\n\nvar hitTestSource = null;\nvar hitTestSourceRequested = false;\n\nvar mtlLoader;\nvar monkeymesh;\n\nexport const init = (stage) => {\n\n\tvar container = document.getElementById(stage);\n    container = document.createElement( 'div' );\n\tdocument.body.appendChild( container );\n\n\tscene = new THREE.Scene();\n\n\tcamera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 0.01, 20 );\n\tcamera.position.z = 10;\n\n\tvar light = new THREE.HemisphereLight( 0xffffff, 0xbbbbff, 1 );\n\tlight.position.set( 0.5, 1, 0.25 );\n\tscene.add( light );\n\n\t//\n\n\trenderer = new THREE.WebGLRenderer( { antialias: true, alpha: true } );\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\trenderer.xr.enabled = true;\n\tcontainer.appendChild( renderer.domElement );\n\n\n\t////////////////////////////////////////////////////////////////////////////////////////////////\n\tmtlLoader = new MTLLoader();\n\tmtlLoader.setPath( \"/var/www/moodle.ianwild.co.uk/public_html/mod/wavefront/samples/\" );\n\tmtlLoader.load( 'greek_vase2.mtl', function ( materials ) {\n\n\t\tmaterials.preload();\n\n\t\tvar objLoader = new OBJLoader();\n\t\tobjLoader.setMaterials( materials );\n\t\tobjLoader.setPath( \"/var/www/moodle.ianwild.co.uk/public_html/mod/wavefront/samples/\" );\n\t\tobjLoader.load( 'greek_vase2.obj', function ( object ) {\n\n\t\t\tmonkeymesh = object;\n\t\t\tscene.add( monkeymesh );\n\n\t\t} );\n\n\t} );\n\n\tvar boxgeometry = new THREE.BoxBufferGeometry( 0.25, 0.25, 0.25 ).translate( 0, 0.1, 0 );\n\n\tfunction onSelect() {\n\n\t\tif ( reticle.visible ) {\n\n\t\t\tvar material = new THREE.MeshPhongMaterial( { color: 0xffffff * Math.random() } );\n\t\t\tvar mesh = new THREE.Mesh( boxgeometry, material );\n\t\t\tmesh.position.setFromMatrixPosition( reticle.matrix );\n\t\t\t//mesh.scale.y = Math.random() * 2 + 1;\n\t\t\tmesh.scale.set( 0.25, 0.25, 0.25 );\n\t\t\tscene.add( mesh );\n\n\n\t\t}\n\n\t}\n\n\tcontroller = renderer.xr.getController( 0 );\n\tcontroller.addEventListener( 'select', onSelect );\n\tscene.add( controller );\n\n\treticle = new THREE.Mesh(\n\t\tnew THREE.RingBufferGeometry( 0.15, 0.2, 32 ).rotateX( - Math.PI / 2 ),\n\t\tnew THREE.MeshBasicMaterial()\n\t);\n\treticle.matrixAutoUpdate = false;\n\treticle.visible = false;\n\tscene.add( reticle );\n\n\t//\n\n\twindow.addEventListener( 'resize', onWindowResize, false );\n\t\n\tanimate();\n};\n\nfunction onWindowResize() {\n\n\tcamera.aspect = window.innerWidth / window.innerHeight;\n\tcamera.updateProjectionMatrix();\n\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\n}\n\nfunction animate() {\n\n\trenderer.setAnimationLoop( render );\n\n}\n\nfunction render( timestamp, frame ) {\n\n\tif ( frame ) {\n\n\t\tvar referenceSpace = renderer.xr.getReferenceSpace();\n\t\tvar session = renderer.xr.getSession();\n\n\t\tif ( hitTestSourceRequested === false ) {\n\n\t\t\tsession.requestReferenceSpace( 'viewer' ).then( function ( referenceSpace ) {\n\n\t\t\t\tsession.requestHitTestSource( { space: referenceSpace } ).then( function ( source ) {\n\n\t\t\t\t\thitTestSource = source;\n\n\t\t\t\t} );\n\n\t\t\t} );\n\n\t\t\tsession.addEventListener( 'end', function () {\n\n\t\t\t\thitTestSourceRequested = false;\n\t\t\t\thitTestSource = null;\n\n\t\t\t} );\n\n\t\t\thitTestSourceRequested = true;\n\n\t\t}\n\n\t\tif ( hitTestSource ) {\n\n\t\t\tvar hitTestResults = frame.getHitTestResults( hitTestSource );\n\n\t\t\tif ( hitTestResults.length ) {\n\n\t\t\t\tvar hit = hitTestResults[ 0 ];\n\n\t\t\t\treticle.visible = true;\n\t\t\t\treticle.matrix.fromArray( hit.getPose( referenceSpace ).transform.matrix );\n\n\t\t\t} else {\n\n\t\t\t\treticle.visible = false;\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\trenderer.render( scene, camera );\n\n}\n\n\t\t"],"file":"ar_renderer.min.js"}